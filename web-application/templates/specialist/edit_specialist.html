{% extends 'base.html' %}
{% load staticfiles widget_tweaks thumbnail %}
{% block head %}
    <link href="{% static 'redactor/redactor.css' %}" type="text/css" media="all" rel="stylesheet"/>
{% endblock %}
{% block content %}
    <main class="specialist_author edit_specialist">
        <form action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="grid">
                <div class="personal_block">
                    <div class="master">
                        <a class="master_img">
					<span>
                        {% if object.photo %}
                            {% thumbnail object.photo "154x154" as im %}
                                <img id="img" src="{{ im.url }}" alt={{ object.full_name }}>
                            {% endthumbnail %}
                        {% endif %}
					</span>
                            <label for="upload">
                                <input type='file' id="upload" name="photo">
                            </label>   
                        </a>

                        <div class="master_desc">
                            <h4>{{ object.full_name }}</h4>
                            <span>
                                {{ object.get_categories }}
                            </span>
                            <span></span>
                            <p>{{ object.short_info }}</p>
                            <ul>
                                <li>
                                    <i class="fa fa-map-marker" aria-hidden="true"></i> {{ object.street_address }}
                                </li>
                                <li>
                                    {% for contact in object.specialist_contacts.all %}
                                        <i class="fa fa-phone" aria-hidden="true"></i> {{ contact.phone }}
                                    {% endfor %}
                                </li>
                                <li>
                                    <i class="fa fa-envelope" aria-hidden="true"></i> {{ object.user.email }}
                                </li>
                            </ul>
                        </div>
                        <a href="#" class="hidden">РЕДАКТИРОВАТЬ</a>
                    </div>
                </div>
                <div class="shedule_block">
                    {% include 'messages.html' %}
                    <div class="edit_block">
                        <div class="general_information">
                            <p>Персональная информация</p>
                            <div class="first_block">
                                <div class="add_block">
                                    <p class="text-danger">{{ form.full_name.errors|striptags }}</p>
                                    {{ form.full_name }}

                                    <p class="text-danger">{{ form.sex.errors|striptags }}</p>
                                    {{ form.sex|add_class:"s_sex" }}

                                    <div class="edit_phone_number">
                                        <table id="id_formset" border="0" cellpadding="0" cellspacing="25">



                                            {% for form in formset %}
                                                <tr id="{{ form.prefix }}-row">
                                                    <td>
                                                        {% for fld in form.hidden_fields %}{{ fld }}{% endfor %}
                                                        {{ form.phone|add_class:"mask" }}
                                                    </td>
                                                    <td class="del_number">
                                                        {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            {#                                            </tbody>#}
                                        </table>
                                        {{ formset.management_form }}
                                    </div>
                                </div>
                                <div>
                                    <p class="text-danger">{{ form.street_address.errors|striptags }}</p>
                                    {{ form.street_address }}
                                    <p class="text-danger">{{ form.short_info.errors|striptags }}</p>
                                    {{ form.short_info }}

                                </div>
                            </div>
                            <p class="text-danger">{{ form.categories.errors|striptags }}</p>
                            <p>Ваши услуги</p>
                            <div class="second_block">
                                <select multiple class="categories-select" id="id_categories" name="categories" required
                                        placeholder="Сфера деятельности" style="width: 50%;">
                                    <option value="7" selected="selected"></option>
                                </select>

                                {{ form.tags }}
                                <p class="text-danger">{{ form.tags.errors|striptags }}</p>
                            </div>
                            <p>Подробная информация</p>
                            {{ form.info }}
                            <p class="text-danger">{{ form.tags.errors|striptags }}</p>

                            <p>Добавление сертификата</p>
                        <table id="id_certificates" class="edit_company_certificates" cellspacing="0">

                            <tbody>
                            {% for form in certificates %}
                                <tr id="{{ form.prefix }}-row">
                                    <td class="chosen_certificate">
                                        {% for fld in form.hidden_fields %}{{ fld }}{% endfor %}
                                        {{ form.certificate }}
                                    </td>
                                    <td class="del_certificate">
                                        {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                                        <img src="{% static 'img/x.png' %}" alt="">
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {{ certificates.management_form }}

                            <button type="submit" class="button">Сохранить</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>
{% endblock %}
{% block js %}
    <script src="{% static 'redactor/redactor.js' %}"></script>
    <script src="{% static 'js/jquery.formset.js' %}"></script>
    <script>

        $('tbody .chosen_certificate').each(function (i, obj) {
            if ($(obj).children('a').length == true) {
                $(obj).prepend('<img src="" alt="">');
                var img_link = $(obj).children('a').attr('href');
                $(obj).children('img').attr('src', img_link);
            }
        });

        $(document).ready(
            function () {
                $('#id_info').redactor({
                    changeCallback(html) {
                        $("#id_info").trigger('change');
                    }
                });
            }
        );

        $('#id_formset tbody tr').formset({
            prefix: 'specialist_contacts',
            addText: 'Добавить контакт',
            deleteText: ''
        });

        $('#id_certificates tbody tr').formset({
            prefix: 'specialist_certifications',
            addText: 'Добавить сертификат',
            deleteText: ''
        });

        var categories = [
            {% for category in all_categories %}
                {% if category.is_child_node and category.get_children %}
                    {
                        "text": "{{ category.name }}",
                        "children": [
                            {% for child in category.get_children %}
                                {
                                    "id": "{{ child.pk }}",
                                    "text": "{{ child.name }}",
                                    "element": HTMLOptionElement
                                },
                            {% endfor %}
                        ],
                        "element": HTMLOptGroupElement
                    },
                {% endif %}
            {% endfor %}
        ];
        (function () {
            var html = '';
            var selectedCategories = [];
            {% for cat in object.categories.all %}
                selectedCategories.push({{cat.id}});
            {% endfor %}
            for (var i = 0; i < categories.length; i++) {
                html += "<optgroup label=" + categories[i].text + ">";
                for (var j = 0; j < categories[i].children.length; j++) {
                    var state = false;
                    for (var k=0; k<selectedCategories.length; k++) {
                        if (selectedCategories[k] == categories[i].children[j].id) {
                            state = true;
                            break;
                        }
                    }
                    if (state) {
                        html += "<option selected='selected' value='" + categories[i].children[j].id + "'>" + categories[i].children[j].text + "</option>"
                    } else {
                        html += "<option value='" + categories[i].children[j].id + "'>" + categories[i].children[j].text + "</option>"
                    }
                }
                html += "</optgroup>";
            }
            $(".categories-select").html(html);
        })();
    </script>
{% endblock %}